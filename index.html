<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Saidpur Village VR - Proximity Trigger</title>
  
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  
  <style>
    body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    #ui-overlay {
      position: fixed; top: 20px; left: 20px; z-index: 1000;
      background: rgba(0, 0, 0, 0.7); color: white; padding: 15px 20px;
      border-radius: 10px; font-size: 14px; backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    #ui-overlay h3 { margin: 0 0 10px 0; font-size: 18px; color: #ffd700; }
    #loading-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 2000; transition: opacity 0.5s ease;
    }
    #loading-screen.hidden { opacity: 0; pointer-events: none; }
    .loader {
      width: 50px; height: 50px; border: 5px solid rgba(255, 215, 0, 0.3);
      border-top: 5px solid #ffd700; border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #exit-video-btn {
      position: fixed; top: 20px; right: 20px; z-index: 1001;
      background: rgba(255, 0, 0, 0.8); color: white; border: none;
      padding: 12px 24px; border-radius: 25px; cursor: pointer; display: none;
    }
    .click-instruction {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      z-index: 999; background: rgba(0, 0, 0, 0.8); color: white;
      padding: 12px 24px; border-radius: 25px; animation: pulse 2s infinite;
    }
    @keyframes pulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
  </style>
</head>

<body>
  <div id="loading-screen">
    <div class="loader"></div>
    <div class="loading-text" style="color: white; margin-top: 20px;">Loading Golden Hour Experience...</div>
  </div>

  <div id="ui-overlay">
    <h3>üèõÔ∏è Saidpur Village VR</h3>
    <p><strong>Controls:</strong></p>
    <p>üñ±Ô∏è Desktop: WASD to move</p>
    <p>üèÉ Walk closer to yellow spheres to enter</p>
  </div>

  <button id="exit-video-btn" onclick="exitVideoMode()">‚Üê Exit Video Mode</button>
  <div class="click-instruction" id="click-instruction">Walk towards hotspots</div>

  <a-scene renderer="antialias: true; colorManagement: true; physicallyCorrectLights: true;" 
           fog="type: exponential; color: #ff9d6e; density: 0.008;">
    
    <a-assets>
      <video id="entrance-video" src="https://hx9v9t89i2.ucarecd.net/eb6e2bc3-c3a4-4622-934e-d2188e3912c4/entrancevideo.MP4" preload="metadata" crossorigin="anonymous" playsinline loop></video>
      <video id="mosque-video" src="https://hx9v9t89i2.ucarecd.net/eb6e2bc3-c3a4-4622-934e-d2188e3912c4/entrancevideo.MP4" preload="metadata" crossorigin="anonymous" playsinline loop></video>
      <img id="sky-tex" src="https://cdn.polyhaven.com/asset_img/primary/sunset_in_the_chalk_quarry.png" crossorigin="anonymous">
      <img id="hills-tex" src="https://cdn.polyhaven.com/asset_img/primary/aerial_rocks_02.png?height=780" crossorigin="anonymous">
      <img id="ground-tex" src="https://cdn.polyhaven.com/asset_img/primary/brown_mud_leaves_01.png?height=780" crossorigin="anonymous">
      <img id="cobble-tex" src="https://cdn.polyhaven.com/asset_img/primary/cobblestone_floor_02.png?height=780" crossorigin="anonymous">
      <img id="brick-tex" src="https://cdn.polyhaven.com/asset_img/primary/red_brick_02.png?height=780" crossorigin="anonymous">
      <img id="stone-tex" src="https://cdn.polyhaven.com/asset_img/primary/rock_wall.png?height=780" crossorigin="anonymous">
      <img id="water-tex" src="https://cdn.polyhaven.com/asset_img/primary/water_002.png?height=780" crossorigin="anonymous">
    </a-assets>

    <a-entity id="environment-world">
        <a-entity light="type: ambient; color: #6e462c; intensity: 0.6;"></a-entity>
        <a-entity light="type: directional; color: #ff8c00; intensity: 2.5; castShadow: true;" position="-20 10 10"></a-entity>
        <a-entity light="type: hemisphere; color: #ffcc33; groundColor: #332211; intensity: 0.8;"></a-entity>

        <a-sky src="#sky-tex" rotation="0 -110 0" material="fog: false;"></a-sky>
        <a-curvedimage src="#hills-tex" height="120" radius="150" theta-length="360" position="0 20 0" material="shader: flat; fog: false; opacity: 0.7; color: #ffccaa;"></a-curvedimage>
        <a-plane rotation="-90 0 0" width="300" height="300" material="src: #ground-tex; repeat: 60 60; roughness: 1; color: #ccaa88;"></a-plane>
        <a-plane rotation="-90 0 0" width="4" height="50" position="0 0.03 -10" material="src: #cobble-tex; repeat: 4 30; color: #dcb;"></a-plane>

        <a-entity position="8 0 0">
          <a-plane rotation="-90 0 0" width="6" height="60" position="0 0.02 -10" 
                  material="src: #water-tex; repeat: 2 18; transparent: true; opacity: 0.8; metalness: 0.9; roughness: 0.1; color: #ffbf00;" 
                  animation="property: material.offset.y; from: 0; to: 1; dur: 10000; loop: true; easing: linear;">
          </a-plane>
          <a-box position="-3.2 0.05 -10" width="0.6" height="0.4" depth="60" material="src: #stone-tex; repeat: 1 10; color: #864;"></a-box>
          <a-box position="3.2 0.05 -10" width="0.6" height="0.4" depth="60" material="src: #stone-tex; repeat: 1 10; color: #864;"></a-box>
        </a-entity>

        <a-entity position="-12 0 -15" rotation="0 25 0">
          <a-box position="0 2 0" width="8" height="4" depth="6" material="src: #brick-tex; repeat: 4 2; color: #d86;"></a-box>
          <a-cone position="0 5 0" radius-bottom="5.5" height="2.5" segments-radial="4" rotation="0 45 0" material="src: #stone-tex; color: #4e342e;"></a-cone>
          <a-entity position="0 2.5 3.05">
              <a-box width="1.5" height="2.2" depth="0.1" material="color: #2b1d12;"></a-box>
              <a-box width="1.3" height="2" depth="0.15" material="color: #ffd700; transparent: true; opacity: 0.3;"></a-box>
          </a-entity>
        </a-entity>

        <a-entity position="0 0 -25">
          <a-box position="0 3.5 0" width="9" height="7" depth="9" material="src: #brick-tex; repeat: 8 5; color: #f5deb3;"></a-box>
          <a-sphere position="0 7 0" radius="4" theta-length="90" material="color: #fcfcfc; roughness: 0.2;"></a-sphere>
          <a-entity position="0 2 -4.55">
              <a-box width="2" height="3.5" depth="0.1" material="color: #3b2b1a;"></a-box>
              <a-box width="1.6" height="3.2" depth="0.15" material="color: #ffd700; opacity: 0.4;"></a-box>
          </a-entity>
        </a-entity>

        <a-entity id="hotspots">
          <a-entity id="entrance-hotspot" position="0 1.5 2" 
                    class="proximity-trigger"
                    data-video="entrance-video"
                    geometry="primitive: sphere; radius: 0.5"
                    material="color: #ffd700; emissive: #ffaa00; emissiveIntensity: 0.5; transparent: true; opacity: 0.6"
                    animation="property: scale; from: 1 1 1; to: 1.2 1.2 1.2; dir: alternate; dur: 1000; loop: true">
              <a-text value="Walk Here" align="center" position="0 0.7 0" width="4"></a-text>
          </a-entity>

          <a-entity id="mosque-hotspot" position="0 1.5 -20" 
                    class="proximity-trigger"
                    data-video="mosque-video"
                    geometry="primitive: sphere; radius: 0.5"
                    material="color: #ffd700; emissive: #ffaa00; emissiveIntensity: 0.5; transparent: true; opacity: 0.6"
                    animation="property: scale; from: 1 1 1; to: 1.2 1.2 1.2; dir: alternate; dur: 1000; loop: true">
              <a-text value="Village Center" align="center" position="0 0.7 0" width="4"></a-text>
          </a-entity>
        </a-entity>
    </a-entity>

    <a-videosphere id="video-display" radius="50" rotation="0 -90 0" visible="false"></a-videosphere>

    <a-entity id="camera-rig" position="0 0 5">
      <a-entity id="main-camera" camera look-controls wasd-controls position="0 1.6 0"></a-entity>
    </a-entity>

  </a-scene>

  <script>
    let isVideoMode = false;
    const videoSphere = document.querySelector('#video-display');
    const environmentWorld = document.querySelector('#environment-world');
    const cameraRig = document.querySelector('#camera-rig');
    const exitBtn = document.querySelector('#exit-video-btn');
    const uiOverlay = document.querySelector('#ui-overlay');
    const instructions = document.querySelector('#click-instruction');
    const mainCamera = document.querySelector('#main-camera');

    // CONFIG: How close to trigger? (2.5 meters ~ 3 steps)
    const TRIGGER_DISTANCE = 2.5; 

    // Store position to calculate return vector
    let lastHotspotPosition = null;

    // --- MAIN LOOP: CHECKS DISTANCE EVERY FRAME ---
    AFRAME.registerComponent('proximity-checker', {
      tick: function () {
        if (isVideoMode) return; // Don't check if already watching video

        const playerPos = cameraRig.object3D.position; // Get player position
        const hotspots = document.querySelectorAll('.proximity-trigger');

        hotspots.forEach(hotspot => {
          const hotspotPos = hotspot.object3D.position;
          
          // Calculate distance
          const distance = playerPos.distanceTo(hotspotPos);

          if (distance < TRIGGER_DISTANCE) {
             const videoId = hotspot.getAttribute('data-video');
             lastHotspotPosition = hotspotPos.clone(); // Remember where we triggered it
             enterVideoMode(videoId);
          }
        });
      }
    });

    // Attach the checker to the scene
    document.querySelector('a-scene').setAttribute('proximity-checker', '');


    function enterVideoMode(videoId) {
      if(isVideoMode) return;
      
      console.log("Entering video mode for: " + videoId);
      isVideoMode = true;

      const video = document.getElementById(videoId);
      video.currentTime = 0; 
      video.play();

      videoSphere.setAttribute('src', '#' + videoId);
      videoSphere.setAttribute('visible', 'true');
      environmentWorld.setAttribute('visible', 'false');

      // Center camera for video
      cameraRig.setAttribute('position', '0 0 0'); 
      // Reset rotation so they face forward in video (optional)
      // mainCamera.setAttribute('rotation', '0 0 0');

      exitBtn.style.display = 'block';
      uiOverlay.style.display = 'none';
      instructions.style.display = 'none';
    }

    function exitVideoMode() {
      isVideoMode = false;
      const videos = document.querySelectorAll('video');
      videos.forEach(v => { v.pause(); });
      
      videoSphere.setAttribute('visible', 'false');
      environmentWorld.setAttribute('visible', 'true');
      
      // LOGIC: Don't put them back IN the hotspot, or it triggers again instantly.
      // We move them 3 meters AWAY from the hotspot they just triggered.
      if (lastHotspotPosition) {
         // Create a safe spot: Start at hotspot
         let safeZ = lastHotspotPosition.z + 3.5; // Move "back" (Positive Z)
         
         // If hotspot was very far back (like the mosque at -20), we move them to -16.5
         // Simple logic: Just push them +3.5 Z from the hotspot center
         cameraRig.setAttribute('position', {
            x: lastHotspotPosition.x,
            y: 0,
            z: safeZ
         });
      } else {
         cameraRig.setAttribute('position', '0 0 5');
      }
      
      exitBtn.style.display = 'none';
      uiOverlay.style.display = 'block';
      instructions.style.display = 'block';
    }

    document.querySelector('a-scene').addEventListener('loaded', () => {
      setTimeout(() => document.querySelector('#loading-screen').classList.add('hidden'), 1500);
    });
  </script>
</body>
</html>